let Url = window.location.origin + "/AdminBCDH/ProcessOrder";
var $ = jQuery.noConflict();
let ProcessOrder = [{ Text: "Đã giao thành công!", Value: '0' }, { Text: "Đã tiếp nhận đơn hàng!", Value: "1" }, { Text: "Lỗi đơn hàng", Value: "2" }, { Text: "Đang tạm giữ", Value: '3' }, { Text: "Đang shipping", Value: '4' }]
var ordersStore = new DevExpress.data.CustomStore({
    key: "IdInvoice",
    load: function () {
        return sendRequest(Url + "/PageOrders", "GET");
    },
   
    update: function (key, values) {
        return sendRequest(Url + "/EditPageOrder", "POST", {
            key: key,
            values: JSON.stringify(values)
        });
    },
   
});

function sendRequest(url, method, data) {
    var d = $.Deferred();
    method = method || "GET";
    $.ajax(url, {
        method: method || "GET",
        data: data,
        cache: false,
        xhrFields: { withCredentials: true }
    }).done(function (result) {
        d.resolve(method === "GET" ? result.data : result);
    }).fail(function (xhr) {
        d.reject(xhr.responseJSON ? xhr.responseJSON.Message : xhr.statusText);
    });
    return d.promise();
}
$("#OrderPage").dxDataGrid({
    dataSource: ordersStore,
    headerFilter: {
        visible: true
    },
    filterPanel: {
        visible: true
    },
    filterRow: {
        visible: true
    },
    paging: {
        pageSize: 5
    },
    pager: {
        showPageSizeSelector: true,
        allowedPageSizes: [2, 5, 15, 25, 35],
        showInfo: true,
        visible: true
    },
    repaintChangesOnly: true,
    showBorders: true,
    columnAutoWidth: true,
    selection: {
        mode: "single"
    },
    onSelectionChanged: function (e) {
        e.component.collapseAll(-1);
        e.component.expandRow(e.currentSelectedRowKeys[0]);
    },
    editing: {
        refreshMode: "full",
        mode: "popup",
        allowUpdating: true,
        texts: {
            confirmDeleteMessage: "Muốn xóa chứ ?",
            deleteRow: "Xóa",
            editRow: "Sửa",
            cancelRowChanges: "Hủy",
            saveRowChanges: "Lưu"
        },
        popup: {
            title: "Chỉnh sửa đơn hàng",
            showTitle: true,
            width: 800,
            height: 500,
            position: {
                my: "top",
                at: "top",
                of: window
            }
        },
        form: {
            items: [{
                itemType: "group",
                colCount: 2,
                colSpan: 2,
                items: ["IdInvoice", "_ProcessOrder", "Status_Order", "MaVanDon","Note"]
            }
            ]
        }
    },
    columns: [
        {
            dataField: "IdInvoice",
            caption: "Mã đơn hàng",
            allowEditing: false,
        },
        {
            dataField: "IdAccount",
            caption: "ID tài khoản",
            allowEditing: false,

        },
        {
            dataField: "_ProcessOrder",
            caption: "Tiến trình đơn hàng",
            lookup: {
                dataSource: ProcessOrder,
                onValueChanged: function (e) {
                    cellInfo.setValue(e.component.option('selectedItem'));
                },
                valueExpr: "Value",
                displayExpr: "Text"
            },
            validationRules: [{
                type: "required",
                message: "Không được để trống"
            }
            ]
        }
        ,
        {
            dataField: "Status_Order",
            caption: "T.trạng đơn hàng",
            
        }
        ,
        {
            dataField: "OrderDate",
            caption: "Thời gian tạo đơn hàng",
            dataType: "date",
            format: "MM/dd/yyyy HH:MM"
        },
        {
            dataField: "MaVanDon",
            caption: "Mã Vận đơn",
        },
        {
            dataField: "Note",
            caption: "Ghi chú",
        }
    ],
    summary: {
        totalItems: [
            {
                column: "IdInvoice",
                summaryType: "count",
                alignment: 'left',
                displayFormat: "Tổng đơn: {0}",
            }
        ]
    },
    masterDetail: {
        enabled: false,
        template: function (container, options) {
            var CurrentorderDetail = options.data;
            var orderDetail = new DevExpress.data.CustomStore({
                key: "IdInvoice",
                load: function (key) {
                    return sendRequest(Url + "/GetOrderDetail","POST", {
                        key: CurrentorderDetail.IdInvoice
                    });
                }
            });
            $("<div>")
                .dxDataGrid({
                    columnAutoWidth: true,
                    showBorders: true,
                    dataSource: orderDetail,
                    columns: [
                        {
                            dataField: "IdInvoice",
                            caption: "Mã đơn hàng",
                            allowEditing: false,
                        },
                        {
                            dataField: "IdProduct",
                            caption: "Mã sản phẩm",
                            allowEditing: false,
                        },
                        {
                            dataField: "Quantity",
                            caption: "Số lượng",
                            allowEditing: false,
                        },
                        {
                            dataField: "Price",
                            caption: "Giá",
                            allowEditing: false,
                        },
                        {
                            dataField: "Payment_Methods",
                            caption: "Phương thức thanh toán",
                            allowEditing: false,
                        },
                        {
                            dataField: "ShippingAddressDetail",
                            caption: "Địa chỉ ship",
                            allowEditing: false,
                        }
                    ],
                  
                }).appendTo(container);
            //$.ajax({
            //    url: Url + "/GetImageForProduct",
            //    method: "GET",
            //    data: { key: options.data.IdInvoice },
            //    success: function (re) {
            //        re.data.map(x => { })
            //       //container.append($('<div class="card"><div class="card-body"><table class="table table-striped">'+""+ '</table></div>'));
            //    }
            //});
            //container.append($('<div class="employeeInfo"><img class="employeePhoto" src="' + "" + '" /><p class="employeeNotes">' + currentEmployeeData.Description + '</p></div>'));
        }
    }
}).dxDataGrid("instance");

