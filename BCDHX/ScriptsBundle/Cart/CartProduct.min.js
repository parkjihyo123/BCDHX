let UrlGetCart = window.location.origin + "/Cart/ShowItemOnCart";
let UrlRemoveProduct = window.location.origin + "/Cart/RemoveItemFromCart";
let UrlUpdateCart = window.location.origin + "/Cart/UpdateItemFromCart";
let UrlUpdateShipFee = window.location.origin + "/Cart/ShippingUpdateLoction";
let UrlUseCuponCode = window.location.origin + "/Cart/UserUseCupon";
let UrlToCart = window.location.origin + "/Cart";
let UrlCheckOut = window.location.origin + "/CheckOut";
$(document).ready(function () {
    ShowMiniCart();
    ShowCartIndex();

});
function ShowMiniCart() {
    fetch(UrlGetCart, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    }).then(res => res.json()).then(x => {
        if (x.data != "Empty" && x.TotalItems != 0) {
            x.data.map(element => { $("#cartStart").append('<li><a class="image"><img src="/Content/ImageUploaded/ImageForProduct/' + element.Img + '"alt="Product"></a><div class="content"><a href="../Product/ProductDetail/?productid=' + element.ID_Product + '" class="title">' + element.Name_Product + '</a><span class="price">Tổng:' + element.Price + '</span><span class="qty">Số Lượng: ' + element.Quantity + '</span></div><button class="remove" onclick="return RemoveProductFromCart(' + "'" + element.ID_Product + "'" + ')"><i class="far fa-trash-alt"></i></button></li>') });
            $("#cartBottom").append('<h4 class="sub-total">Tổng cộng: <span>' + x.TotalPrice + '</span></h4><div class="button"><a href="'+ UrlToCart+'">Thanh toán</a></div>');
            $("#zone").html('<a href="../WishListProduct/" class="header-wishlist"><i class="ti-heart"></i> <span class="number">' + x.WishListCount + '</span></a><a href="#" class="header-cart"  onclick="return ShowOverPlay()"><i class="ti-shopping-cart"></i> <span class="number">' + x.TotalItems + '</span></a>');
        } else {
            $("#cartBottom").append('<h4 class="sub-total">Tổng cộng: <span> 0 vnđ</span></h4><div class="button"><a href="' + UrlToCart+'">Thanh toán</a></div>');
            $("#zone").html('<a href="../WishListProduct/" class="header-wishlist"><i class="ti-heart"></i> <span class="number">' + x.WishListCount + '</span></a><a href="#" class="header-cart"  onclick="return ShowOverPlay()"><i class="ti-shopping-cart"></i> <span class="number">0</span></a>');
        }

    })
}

function LoadCartAfterAdded() {
    fetch(UrlGetCart, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    }).then(res => res.json()).then(x => {
        $("#cartStart").empty();
        $("#cartBottom").empty();
        if (x.data != "Empty" && x.TotalItems != 0) {
            x.data.map(element => { $("#cartStart").append('<li><a class="image"><img src="/Content/ImageUploaded/ImageForProduct/' + element.Img + '"alt="Product"></a><div class="content"><a href="../Product/ProductDetail/?productid=' + element.ID_Product + '" class="title">' + element.Name_Product + '</a><span class="price">Tổng:' + element.Price + '</span><span class="qty">Số Lượng: ' + element.Quantity + '</span></div><button class="remove" onclick="return RemoveProductFromCart(' + "'" + element.ID_Product + "'" + ')"><i class="far fa-trash-alt"></i></button></li>') });
            $("#cartBottom").append('<h4 class="sub-total">Tổng cộng: <span>' + x.TotalPrice + '</span></h4><div class="button"><a href="' + UrlToCart +'">Thanh toán</a></div>');
            $("#zone").html('<a href="../WishListProduct/" class="header-wishlist"><i class="ti-heart"></i> <span class="number">' + x.WishListCount + '</span></a><a href="#" class="header-cart"  onclick="return ShowOverPlay()"><i class="ti-shopping-cart"></i> <span class="number">' + x.TotalItems + '</span></a>');
        } else {
            $("#cartBottom").append('<h4 class="sub-total">Tổng cộng: <span> 0 vnđ</span></h4><div class="button"><a href="' + UrlToCart +'">Thanh toán</a></div>');
            $("#zone").html('<a href="../WishListProduct/" class="header-wishlist"><i class="ti-heart"></i> <span class="number">' + x.WishListCount + '</span></a><a href="#" class="header-cart"  onclick="return ShowOverPlay()"><i class="ti-shopping-cart"></i> <span class="number">0</span></a>');
        }
    })
}

function RemoveProductFromCart(id) {
    let temp = { productId: id }
    fetch(UrlRemoveProduct, {
        method: "POST",
        body: JSON.stringify(temp),
        headers: {
            'Content-Type': 'application/json'
        }
    }).then(res => res.json()).then(result => {
        if (result.Status == 1) {
            LoadCartAfterAdded();
            ShowCartIndex();
        }
    })
}
let closeCart = $('.close-cart, .cart-overlay');
let miniCartWrap = $('.mini-cart-wrap');
function ShowOverPlay() {
    $('.cart-overlay').addClass('visible');
    miniCartWrap.addClass('open');
}
closeCart.on('click', function (e) {
    e.preventDefault();
    $('.cart-overlay').removeClass('visible');
    miniCartWrap.removeClass('open');
});
function ShowCartIndex() {
    fetch(UrlGetCart, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    }).then(res => res.json()).then(x => {
        if (x.data != "Empty" && x.TotalItems != 0) {
            $("#tableCart").empty();
            x.data.map(element => { $("#tableCart").append('<tr><td class="pro-thumbnail"><a href="#"><img src="/Content/ImageUploaded/ImageForProduct/' + element.Img + '" alt="Product"></a></td><td class="pro-title"><a href="../Product/ProductDetail/?productid=' + element.ID_Product + '">' + element.Name_Product + '</a></td><td class="pro-quantity"><div class="pro-qty" ><input class="txtQuantity" data-id="' + element.ID_Product + '"  type="number" min="1" max="256" onkeypress="return event.charCode >= 48 && event.charCode <= 57" value="' + element.Quantity + '"></div></td><td class="pro-title"><a href="#">' + element.Ver + '</a></td><td class="pro-subtotal"><span>' + element.Price + '</span></td> <td class="pro-remove"><a href="#" onclick="return RemoveProductFromCart(' + "'" + element.ID_Product + "'" + ')"><i class="far fa-trash-alt"></i></a></td></tr>') });
            $("#cartSummary").html('<h4>Tóm tắt giỏ hàng</h4> <p>Tổng Tiền<span>' + x.TotalPrice + '</span></p><p>Tiền Shipping <span>' + x.ShippingFeeLast + '</span></p> <h2>Grand Total <span>' + x.TotalPriceGrand + '</span></h2>');
        } else {
            $("#masterzoneCartTable").html('<p style="font-size:22px;font-weight:bold;">Giỏ hàng trống!</p>')
            $("#cartSummary").html('<h4>Tóm tắt giỏ hàng</h4> <p>Tổng Tiền<span>0</span></p><p>Tiền Shipping<span>0</span></p> <h2>Grand Total <span>0</span></h2>');
        }
    })
}
$("#ShippingLocationSelection").on("change", function (e) {
    e.preventDefault();
    let optionSelected = $("#ShippingLocationSelection option:selected").val();
    let temp = { location: optionSelected }
    fetch(UrlUpdateShipFee, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(temp)
    }).then(res => res.json()).then(res => {
        if (res.Status == 1) {
            ShowCartIndex();
        } else {
            Swal.fire({
                type: 'error',
                title: res.Error,
                showConfirmButton: true,
                confirmButtonColor: '#F3D930',
                allowOutsideClick: false
            })
        }
    })
})

//
//   
//    
//   
$(document).on("change", ".txtQuantity", function (e) {
    e.preventDefault();
    let quantiy = $(".txtQuantity");
    let ListTemp = [];
    $.each(quantiy, function (i, item) {
        ListTemp.push({
            QuantityToCT: $(item).val(),
            ID: $(item).data('id')
        })

    });
    $.ajax({
        type: "POST",
        url: UrlUpdateCart,
        data: { Items: JSON.stringify(ListTemp) },
        success: function (res) {
            Swal.fire({
                type: 'success',
                title: res.Error,
                showConfirmButton: true,
                confirmButtonColor: '#F3D930',
                allowOutsideClick: false
            }).then((result) => {
                if (result.value) {
                    ShowCartIndex();
                    LoadCartAfterAdded();
                }
            })
        }
    })
})

$("#CouponForm").on("submit", function (e) {
    e.preventDefault();
    let temp = { code: $("#cuponCode").val() }
    let optionSelected = $("#ShippingLocationSelection option:selected").val();
    if (optionSelected == 0) {
        Swal.fire({
            type: 'error',
            title: 'Chọn Khu vực shipping trước tiên!',
            showConfirmButton: true,
            confirmButtonColor: '#F3D930'
        })
    } else {
        $.ajax({
            type: "POST",
            url: UrlUseCuponCode,
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(temp),
            success: function (res) {
                if (res.Status == 1) {
                    Swal.fire({
                        type: 'success',
                        title: res.Error,
                        showConfirmButton: true,
                        confirmButtonColor: '#F3D930',
                        allowOutsideClick: false
                    }).then((result) => {
                        if (result.value) {
                            ShowCartIndex();
                            LoadCartAfterAdded();
                        }
                    })
                } else if (res.Status == 3 || res.Status == 4 || res.Status == 5 || res.Status == 6) {
                    Swal.fire({
                        type: 'error',
                        title: res.Error,
                        showConfirmButton: true,
                        confirmButtonColor: '#F3D930'
                    })
                } else {
                    Swal.fire({
                        type: 'error',
                        title: "Bạn phải đăng nhập mới sử dụng cupon được!",
                        showConfirmButton: true,
                        confirmButtonColor: '#F3D930'
                    }).then((result) => {
                        if (result.value) {
                            $("#elegantModalForm").modal('show');
                            // window.location.href = window.location.origin + "/Account/Login";
                        }
                    })
                }

            }
        })
    }
   
})

$("#CheckOutBt").on("click", function (e) {
    e.preventDefault();
    let optionSelected = $("#ShippingLocationSelection option:selected").val();
    if (optionSelected == 0) {
        Swal.fire({
            type: 'error',
            title: 'Chọn Khu vực shipping trước tiên!',
            showConfirmButton: true,
            confirmButtonColor: '#F3D930'
        })
    } else {
        window.location.href = UrlCheckOut;
    }
})
